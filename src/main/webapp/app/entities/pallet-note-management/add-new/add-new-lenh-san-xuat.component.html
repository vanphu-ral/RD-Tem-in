<div class="main-content">
  <div class="header">
    <h3>Tạo TEM/Phiếu cho lệnh sản xuất</h3>
    <div
      style="z-index: 99999"
      class="submit-search-sap"
      [formGroup]="form"
      *ngIf="!isDetail"
    >
      <mat-form-field appearance="outline" class="sap-input">
        <mat-label>Mã lệnh sản xuất</mat-label>
        <input
          matInput
          formControlName="woId"
          placeholder="Nhập lệnh sx..."
          (keydown.enter)="onApply()"
          (input)="removeSpaces()"
        />
        <mat-error
          *ngIf="
            form.get('woId')?.hasError('required') && form.get('woId')?.touched
          "
        >
          Vui lòng nhập mã lệnh SX
        </mat-error>
      </mat-form-field>

      <button
        mat-raised-button
        color="primary"
        class="search-button"
        (click)="onApply()"
      >
        <mat-icon>check_circle_outline</mat-icon>
        Apply
      </button>
    </div>
  </div>

  <div class="table-wrapper">
    <div class="table-container desktop-only">
      <mat-progress-bar
        *ngIf="loading"
        mode="indeterminate"
        color="primary"
      ></mat-progress-bar>
      <table mat-table [dataSource]="productionOrders" class="production-table">
        <ng-container matColumnDef="maLenhSanXuat">
          <th mat-header-cell *matHeaderCellDef>Mã lệnh sản xuất</th>
          <td mat-cell data-label="Mã lệnh SX" *matCellDef="let element">
            {{ element.maLenhSanXuat }}
          </td>
        </ng-container>

        <ng-container matColumnDef="maSAP">
          <th mat-header-cell *matHeaderCellDef>Mã SAP</th>
          <td mat-cell data-label="Mã SAP" *matCellDef="let element">
            {{ element.maSAP }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tenHangHoa">
          <th mat-header-cell *matHeaderCellDef>Tên hàng hoá</th>
          <td mat-cell data-label="Tên hàng hóa" *matCellDef="let element">
            {{ element.tenHangHoa }}
          </td>
        </ng-container>

        <ng-container matColumnDef="maWO">
          <th mat-header-cell *matHeaderCellDef>Mã WO</th>
          <td mat-cell data-label="Mã WO" *matCellDef="let element">
            {{ element.maWO }}
          </td>
        </ng-container>

        <ng-container matColumnDef="version">
          <th mat-header-cell *matHeaderCellDef>Version</th>
          <td mat-cell data-label="Version" *matCellDef="let element">
            {{ element.version }}
          </td>
        </ng-container>

        <ng-container matColumnDef="maKhoNhap">
          <th mat-header-cell *matHeaderCellDef>Mã kho nhập</th>
          <td mat-cell data-label="Mã kho nhập" *matCellDef="let element">
            <mat-form-field appearance="outline" class="compact-field">
              <mat-select
                [(ngModel)]="element.maKhoNhap"
                placeholder="Chọn kho"
                (selectionChange)="onMaKhoNhapChange($event.value)"
              >
                <ng-container
                  *ngIf="
                    element.loaiSanPham === 'Bán thành phẩm';
                    else tpOptions
                  "
                >
                  <mat-option
                    *ngFor="let opt of maKhoNhapOptionsBTP"
                    [value]="opt.value"
                  >
                    {{ opt.label }}
                  </mat-option>
                </ng-container>
                <ng-template #tpOptions>
                  <mat-option
                    *ngFor="let opt of maKhoNhapOptionsTP"
                    [value]="opt.value"
                  >
                    {{ opt.label }}
                  </mat-option>
                </ng-template>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="nganh">
          <th mat-header-cell *matHeaderCellDef>Ngành</th>
          <td mat-cell *matCellDef="let element">{{ element.nganh }}</td>
        </ng-container>

        <ng-container matColumnDef="to">
          <th mat-header-cell *matHeaderCellDef>Tổ</th>
          <td mat-cell *matCellDef="let element">{{ element.to }}</td>
        </ng-container>

        <ng-container matColumnDef="tongSoLuong">
          <th mat-header-cell *matHeaderCellDef>Tổng số lượng</th>
          <td mat-cell data-label="Tổng SL" *matCellDef="let element">
            {{ element.tongSoLuong }}
          </td>
        </ng-container>

        <ng-container matColumnDef="trangThai">
          <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
          <td mat-cell data-label="Trạng thái" *matCellDef="let element">
            {{ element.trangThai }}
          </td>
        </ng-container>

        <ng-container matColumnDef="loaiSanPham">
          <th mat-header-cell *matHeaderCellDef>Loại sản phẩm</th>
          <td mat-cell data-label="Loại SP" *matCellDef="let element">
            {{ element.loaiSanPham }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
    <div class="mobile-cards mobile-only">
      <mat-progress-bar
        *ngIf="loading"
        mode="indeterminate"
        color="primary"
      ></mat-progress-bar>
      <div class="mobile-card" *ngFor="let element of productionOrders">
        <!-- Header with Product Type Badge -->
        <div class="card-header">
          <div
            class="product-type-badge"
            [class.btp]="element.loaiSanPham === 'Bán thành phẩm'"
          >
            {{ element.loaiSanPham }}
          </div>
          <div
            class="status-badge"
            [class.active]="element.trangThai === 'Hoạt động'"
          >
            {{ element.trangThai }}
          </div>
        </div>

        <!-- Main Info -->
        <div class="card-body">
          <!-- <div class="info-row primary">
            <mat-icon class="info-icon">article</mat-icon>
            <div class="info-content">
              <span class="info-label">Mã lệnh SX</span>
              <span class="info-value">{{ element.maLenhSanXuat }}</span>
            </div>
          </div> -->

          <div class="info-row">
            <mat-icon class="info-icon">inventory_2</mat-icon>
            <div class="info-content">
              <span class="info-label">Tên hàng hóa</span>
              <span class="info-value">{{ element.tenHangHoa }}</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Mã SAP</span>
              <span class="info-value">{{ element.maSAP }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Mã WO</span>
              <span class="info-value">{{ element.maWO }}</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Version</span>
              <span class="info-value">{{ element.version }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Tổng SL</span>
              <span class="info-value highlight">{{
                element.tongSoLuong
              }}</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Ngành</span>
              <span class="info-value">{{ element.nganh }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Tổ</span>
              <span class="info-value">{{ element.to }}</span>
            </div>
          </div>

          <!-- Warehouse Select -->
          <div class="info-grid">
            <div class="info-item">
              <div class="warehouse-select">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Mã kho nhập</mat-label>
                  <mat-select
                    [(value)]="element.maKhoNhap"
                    placeholder="Chọn kho"
                    (selectionChange)="onMaKhoNhapChange($event.value)"
                  >
                    <ng-container
                      *ngIf="
                        element.loaiSanPham === 'Bán thành phẩm';
                        else tpOptionsMobile
                      "
                    >
                      <mat-option
                        *ngFor="let opt of maKhoNhapOptionsBTP"
                        [value]="opt.value"
                      >
                        {{ opt.label }}
                      </mat-option>
                    </ng-container>
                    <ng-template #tpOptionsMobile>
                      <mat-option
                        *ngFor="let opt of maKhoNhapOptionsTP"
                        [value]="opt.value"
                      >
                        {{ opt.label }}
                      </mat-option>
                    </ng-template>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            <!-- <div class="info-item">
              <div class="info-content">
                <span class="info-label">Mã lệnh SX</span>
                <span class="info-value">{{ element.maLenhSanXuat }}</span>
              </div>
            </div> -->
          </div>
        </div>
      </div>
    </div>
    <div class="action-buttons">
      <button mat-raised-button color="primary" (click)="saveWarehouseNotes()">
        <mat-icon>save</mat-icon>
        Lưu ghi chú kho
      </button>
    </div>
  </div>

  <div
    class="fab-backdrop"
    [class.active]="fabMenuOpen"
    (click)="toggleFabMenu()"
  ></div>

  <div class="tabs-wrapper">
    <mat-tab-group class="management-tabs" [(selectedIndex)]="selectedTabIndex">
      <mat-tab *ngIf="showThungTab">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">view_in_ar</mat-icon>
          <span class="mdc-tab__text-label">Thùng</span>
        </ng-template>

        <div class="tab-content">
          <!-- Thùng tab: đặt ngay trong <div class="tab-content"> của tab Thùng -->
          <div class="summary-cards" role="region" aria-label="Tổng hợp Thùng">
            <div class="summary-card">
              <div class="summary-card__icon">
                <mat-icon>list_alt</mat-icon>
              </div>
              <div class="summary-card__body">
                <div class="summary-card__label">Số lần tạo</div>
                <div class="summary-card__value">
                  {{ boxSummaryContext.totalRows }}
                </div>
                <div class="summary-card__meta">Dòng hiển thị trong bảng</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card__icon">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <div class="summary-card__body">
                <div class="summary-card__label">Tổng thùng</div>
                <div class="summary-card__value">
                  {{ boxSummaryContext.totalBoxes }}
                </div>
                <div class="summary-card__meta">Số thùng tổng cộng</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card__icon">
                <mat-icon>shopping_cart</mat-icon>
              </div>
              <div class="summary-card__body">
                <div class="summary-card__label">Tổng sản phẩm</div>
                <div class="summary-card__value">
                  {{ boxSummaryContext.totalItems }}
                </div>
                <div class="summary-card__meta">Tổng số sản phẩm</div>
              </div>
            </div>
          </div>

          <div class="items-table-container">
            <mat-progress-bar
              *ngIf="loadingBox"
              mode="indeterminate"
              color="primary"
            ></mat-progress-bar>
            <table mat-table [dataSource]="boxItems" class="items-table">
              <ng-container matColumnDef="stt">
                <th mat-header-cell *matHeaderCellDef style="width: 50px">
                  STT
                </th>
                <td mat-cell data-label="STT" *matCellDef="let element">
                  {{ element.stt }}
                </td>
              </ng-container>

              <ng-container matColumnDef="maSanPham">
                <th mat-header-cell *matHeaderCellDef>Mã sản phẩm</th>
                <td mat-cell data-label="Mã SP" *matCellDef="let element">
                  {{ element.maSanPham }}
                </td>
              </ng-container>

              <ng-container matColumnDef="tenSanPham">
                <th mat-header-cell *matHeaderCellDef>Tên sản phẩm</th>
                <td mat-cell data-label="Tên SP" *matCellDef="let element">
                  {{ element.tenSanPham }}
                </td>
              </ng-container>

              <ng-container matColumnDef="lotNumber">
                <th mat-header-cell *matHeaderCellDef>Lot Number</th>
                <td mat-cell data-label="Lot Number" *matCellDef="let element">
                  {{ element.lotNumber }}
                </td>
              </ng-container>

              <ng-container matColumnDef="soLuongThung">
                <th mat-header-cell *matHeaderCellDef>Số lượng thùng</th>
                <td mat-cell data-label="SL thùng" *matCellDef="let element">
                  {{ element.soLuongThung }}
                </td>
              </ng-container>

              <ng-container matColumnDef="soLuongSp">
                <th mat-header-cell *matHeaderCellDef>Số lượng SP</th>
                <td mat-cell data-label="SL SP" *matCellDef="let element">
                  {{ element.soLuongSp }}
                </td>
              </ng-container>

              <ng-container matColumnDef="ghiChu">
                <th mat-header-cell *matHeaderCellDef>Ghi chú</th>
                <td mat-cell data-label="Ghi chú" *matCellDef="let element">
                  {{ element.ghiChu }}
                </td>
              </ng-container>

              <ng-container matColumnDef="kho">
                <th mat-header-cell *matHeaderCellDef>Kho</th>
                <td mat-cell data-label="Kho" *matCellDef="let element">
                  {{ element.kho }}
                </td>
              </ng-container>

              <ng-container matColumnDef="tuyChon">
                <th mat-header-cell *matHeaderCellDef>Tuỳ chọn</th>
                <td
                  mat-cell
                  data-label=""
                  *matCellDef="let element; let i = index"
                >
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="openBoxDetailDialog(element)"
                    matTooltip="Xem chi tiết"
                    matTooltipPosition="left"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="deleteBox(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="boxColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: boxColumns"></tr>
            </table>
            <div class="box-cards-mobile d-md-none">
              <div
                class="box-card-mobile"
                *ngFor="let element of boxItems; let i = index"
              >
                <div class="card-header">
                  <span class="card-number">#{{ element.stt }}</span>
                  <span class="card-badge">{{ element.maSanPham }}</span>
                </div>
                <div class="card-body">
                  <div class="card-row">
                    <span class="label">Tên SP:</span>
                    <span class="value" [title]="element.tenSanPham">{{
                      element.tenSanPham
                    }}</span>
                  </div>
                  <div class="card-row">
                    <span class="label">Lot:</span>
                    <span class="value">{{ element.lotNumber }}</span>
                  </div>
                  <div class="card-row">
                    <span class="label">SL thùng:</span>
                    <span class="value highlight">{{
                      element.soLuongThung
                    }}</span>
                  </div>
                  <div class="card-row">
                    <span class="label">SL SP:</span>
                    <span class="value highlight">{{ element.soLuongSp }}</span>
                  </div>
                  <div class="card-row">
                    <span class="label">Kho:</span>
                    <span class="value">{{ element.kho }}</span>
                  </div>
                  <div class="card-row" *ngIf="element.ghiChu">
                    <span class="label">Ghi chú:</span>
                    <span class="value">{{ element.ghiChu }}</span>
                  </div>
                  <div class="card-actions">
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="openBoxDetailDialog(element)"
                    >
                      <mat-icon>visibility</mat-icon>
                      Chi tiết
                    </button>
                    <button
                      mat-stroked-button
                      color="warn"
                      (click)="deleteBox(i)"
                    >
                      <mat-icon>delete</mat-icon>
                      Xóa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Mobile card view -->
        </div>
      </mat-tab>

      <mat-tab *ngIf="showPalletTab">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">layers</mat-icon>
          <span class="mdc-tab__text-label">Pallet</span>
        </ng-template>

        <div class="tab-content">
          <div class="summary-cards" role="region" aria-label="Tổng hợp Pallet">
            <div class="summary-card">
              <div class="summary-card__icon">
                <mat-icon>list_alt</mat-icon>
              </div>
              <div class="summary-card__body">
                <div class="summary-card__label">Số lần tạo</div>
                <div class="summary-card__value">
                  {{ palletSummaryContext.totalRows }}
                </div>
                <div class="summary-card__meta">Dòng hiển thị trong bảng</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card__icon"><mat-icon>layers</mat-icon></div>
              <div class="summary-card__body">
                <div class="summary-card__label">Tổng pallet</div>
                <div class="summary-card__value">
                  {{ palletSummaryContext.totalPallets }}
                </div>
                <div class="summary-card__meta">Số pallet tổng cộng</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card__icon">
                <mat-icon>shopping_cart</mat-icon>
              </div>
              <div class="summary-card__body">
                <div class="summary-card__label">Tổng số thùng</div>
                <div class="summary-card__value">
                  {{ palletSummaryContext.totalItems }}
                </div>
                <div class="summary-card__meta">Tổng số thùng</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card__icon"><mat-icon>grain</mat-icon></div>
              <div class="summary-card__body">
                <div class="summary-card__label">Tổng số PO</div>
                <div class="summary-card__value">
                  {{ palletSummaryContext.totalPO }}
                </div>
                <div class="summary-card__meta">Số PO khác nhau</div>
              </div>
            </div>
          </div>
          <div class="items-table-container">
            <table mat-table [dataSource]="palletItems" class="items-table">
              <ng-container matColumnDef="stt">
                <th mat-header-cell *matHeaderCellDef style="width: 50px">
                  STT
                </th>
                <td mat-cell data-label="STT" *matCellDef="let element">
                  {{ element.stt }}
                </td>
              </ng-container>

              <ng-container matColumnDef="tenSanPham">
                <th mat-header-cell *matHeaderCellDef>Tên sản phẩm</th>
                <td mat-cell data-label="Tên SP" *matCellDef="let element">
                  {{ element.tenSanPham }}
                </td>
              </ng-container>

              <ng-container matColumnDef="noSKU">
                <th mat-header-cell *matHeaderCellDef>No/SKU</th>
                <td mat-cell data-label="No/SKU" *matCellDef="let element">
                  {{ element.noSKU }}
                </td>
              </ng-container>

              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef>Thời gian tạo</th>
                <td mat-cell data-label="Thời gian" *matCellDef="let element">
                  {{ element.createdAt | date: "yyyy-MM-dd HH:mm:ss" }}
                </td>
              </ng-container>

              <ng-container matColumnDef="khachHang">
                <th mat-header-cell *matHeaderCellDef>Khách hàng</th>
                <td mat-cell data-label="Khách hàng" *matCellDef="let element">
                  {{ element.khachHang }}
                </td>
              </ng-container>

              <ng-container matColumnDef="poNumber">
                <th mat-header-cell *matHeaderCellDef>PO Number</th>
                <td
                  style="font-weight: bold; font-size: large"
                  mat-cell
                  data-label="PO Number"
                  *matCellDef="let element"
                >
                  {{ element.poNumber }}
                </td>
              </ng-container>

              <ng-container matColumnDef="dateCode">
                <th mat-header-cell *matHeaderCellDef>Date Code</th>
                <td mat-cell data-label="Date Code" *matCellDef="let element">
                  {{ element.dateCode }}
                </td>
              </ng-container>

              <ng-container matColumnDef="qdsx">
                <th mat-header-cell *matHeaderCellDef>QDSX</th>
                <td mat-cell data-label="QDSX" *matCellDef="let element">
                  {{ element.qdsx }}
                </td>
              </ng-container>

              <ng-container matColumnDef="nguoiKiemTra">
                <th mat-header-cell *matHeaderCellDef>Người kiểm tra</th>
                <td mat-cell data-label="Người KT" *matCellDef="let element">
                  {{ element.nguoiKiemTra }}
                </td>
              </ng-container>

              <ng-container matColumnDef="ketQuaKiemTra">
                <th mat-header-cell *matHeaderCellDef>Kết quả kiểm tra</th>
                <td mat-cell data-label="KQ KT" *matCellDef="let element">
                  {{ element.ketQuaKiemTra }}
                </td>
              </ng-container>

              <ng-container matColumnDef="tongPallet">
                <th mat-header-cell *matHeaderCellDef>Tổng pallet</th>
                <td mat-cell data-label="Tổng pallet" *matCellDef="let element">
                  {{ element.tongPallet }}
                </td>
              </ng-container>

              <!-- <ng-container matColumnDef="tongSlSp">
                <th mat-header-cell *matHeaderCellDef>Tổng sản phẩm</th>
                <td mat-cell data-label="Tổng SP" *matCellDef="let element">
                  {{ element.tongSlSp }}
                </td>
              </ng-container> -->

              <ng-container matColumnDef="tongSoThung">
                <th mat-header-cell *matHeaderCellDef>Tổng số thùng</th>
                <td mat-cell data-label="Tổng thùng" *matCellDef="let element">
                  {{ element.tongSoThung }}
                </td>
              </ng-container>
              <ng-container matColumnDef="note">
                <th mat-header-cell *matHeaderCellDef>Ghi chú</th>
                <td mat-cell data-label="Ghi chú" *matCellDef="let element">
                  {{ element.note }}
                </td>
              </ng-container>

              <ng-container matColumnDef="trangThaiIn">
                <th mat-header-cell *matHeaderCellDef>Trạng thái in</th>
                <td mat-cell data-label="TT in" *matCellDef="let element">
                  <span
                    class="status-badge"
                    [ngClass]="element.trangThaiIn ? 'printed' : 'not-printed'"
                  >
                    {{ element.trangThaiIn ? "Đã in" : "Chưa in" }}
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="tuyChon">
                <th mat-header-cell *matHeaderCellDef>Tuỳ chọn</th>
                <td mat-cell data-label="" *matCellDef="let element">
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="openPalletDetailDialog(element)"
                    matTooltip="Xem chi tiết"
                    matTooltipPosition="left"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <!-- <button mat-icon-button color="primary">
                    <mat-icon>system_update_alt</mat-icon>
                  </button> -->
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="deletePallet(element)"
                    [disabled]="element.trangThaiIn"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="palletColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: palletColumns"></tr>
            </table>
            <!-- Mobile card view -->
            <div class="pallet-cards-mobile d-md-none">
              <div
                class="pallet-card-mobile"
                *ngFor="let element of palletItems"
              >
                <div class="card-header">
                  <span class="card-number">#{{ element.stt }}</span>
                  <span
                    class="status-badge"
                    [ngClass]="element.trangThaiIn ? 'printed' : 'not-printed'"
                  >
                    {{ element.trangThaiIn ? "Đã in" : "Chưa in" }}
                  </span>
                </div>
                <div class="card-body">
                  <div class="card-section">
                    <div class="section-title">Sản phẩm</div>
                    <div class="section-content">{{ element.tenSanPham }}</div>
                  </div>
                  <div class="d-flex">
                    <div class="card-section">
                      <div class="section-title">No/SKU</div>
                      <div class="section-content">{{ element.noSKU }}</div>
                    </div>
                    <div class="card-section">
                      <div class="section-title">Khách hàng</div>
                      <div class="section-content">{{ element.khachHang }}</div>
                    </div>
                  </div>
                  <div class="card-section">
                    <div class="section-title po_number">PO Number</div>
                    <div class="section-content po_number">
                      {{ element.poNumber }}
                    </div>
                  </div>

                  <div class="card-stats">
                    <div class="stat-item">
                      <span class="stat-label">Pallet</span>
                      <span class="stat-value">{{ element.tongPallet }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">Thùng</span>
                      <span class="stat-value">{{ element.tongSoThung }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">PO</span>
                      <span class="stat-value">1</span>
                    </div>
                  </div>

                  <div class="card-section" *ngIf="element.note">
                    <div class="section-title">Ghi chú</div>
                    <div class="section-content">{{ element.note }}</div>
                  </div>

                  <div class="card-actions">
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="openPalletDetailDialog(element)"
                    >
                      <mat-icon>visibility</mat-icon>
                      Chi tiết
                    </button>
                    <button
                      mat-stroked-button
                      color="warn"
                      (click)="deletePallet(element)"
                      [disabled]="element.trangThaiIn"
                    >
                      <mat-icon>delete</mat-icon>
                      Xóa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab *ngIf="showTemBtpTab">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">qr_code</mat-icon>
          <span class="mdc-tab__text-label">Tem BTP</span>
        </ng-template>

        <div class="tab-content">
          <div class="btp-group-btn">
            <button
              mat-raised-button
              color="primary"
              class="add-box-btn"
              (click)="exportTemBtpCsv()"
            >
              <mat-icon>save_alt</mat-icon>
              Xuất CSV
            </button>
            <button
              mat-raised-button
              color="primary"
              class="add-box-btn"
              (click)="exportExcelReelData()"
            >
              <mat-icon>text_snippet</mat-icon>
              Xuất Excel
            </button>
          </div>
          <div class="items-table-container scroll-container">
            <table
              mat-table
              [dataSource]="reelGroups"
              class="items-table tem-btp-table"
            >
              <ng-container matColumnDef="stt">
                <th mat-header-cell *matHeaderCellDef>STT</th>
                <td
                  mat-cell
                  data-label="STT"
                  *matCellDef="let element; let i = index"
                >
                  {{ i + 1 }}
                </td>
              </ng-container>

              <!-- <ng-container matColumnDef="reelID">
                <th mat-header-cell *matHeaderCellDef>Reel ID</th>
                <td mat-cell data-label="Reel ID" *matCellDef="let element">
                  {{ element.reelID }}
                </td>
              </ng-container> -->
              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef>Created at</th>
                <td mat-cell data-label="Reel ID" *matCellDef="let element">
                  {{
                    element.createdAt
                      ? (element.createdAt | date: "yyyy-MM-dd HH:mm")
                      : element.reelGroupKey || "-"
                  }}
                </td>
              </ng-container>

              <ng-container matColumnDef="partNumber">
                <th mat-header-cell *matHeaderCellDef>Part Number</th>
                <td mat-cell data-label="Part Number" *matCellDef="let element">
                  {{ element.partNumber }}
                </td>
              </ng-container>

              <!-- <ng-container matColumnDef="vendor">
                <th mat-header-cell *matHeaderCellDef>Vendor</th>
                <td mat-cell data-label="Vendor" *matCellDef="let element">
                  {{ element.vendor }}
                </td>
              </ng-container> -->

              <ng-container matColumnDef="lot">
                <th mat-header-cell *matHeaderCellDef>Lot</th>
                <td mat-cell data-label="Lot" *matCellDef="let element">
                  {{ element.lot }}
                </td>
              </ng-container>

              <ng-container matColumnDef="storageUnit">
                <th mat-header-cell *matHeaderCellDef>
                  Chọn kho
                  <div
                    class="header-actions"
                    style="display: flex; align-items: center; gap: 8px"
                  >
                    <mat-form-field
                      appearance="outline"
                      class="compact-field"
                      style="width: 80%; background: #fff"
                    >
                      <!-- Header autocomplete + Enter để apply -->
                      <input
                        matInput
                        placeholder="Chọn kho"
                        [(ngModel)]="storageUnitHeaderValue"
                        (keydown.enter)="applyStorageUnitToAll()"
                        [matAutocomplete]="autoHeader"
                        (ngModelChange)="onHeaderStorageUnitChange($event)"
                      />
                      <mat-autocomplete
                        #autoHeader="matAutocomplete"
                        [displayWith]="displayAreaLabel"
                      >
                        <mat-option
                          *ngFor="let opt of filteredHeaderOptions | async"
                          [value]="opt.value"
                        >
                          {{ opt.label }}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>

                    <button
                      mat-icon-button
                      color="primary"
                      (click)="applyStorageUnitToAll()"
                      class="header-actions-btn"
                    >
                      <mat-icon>check</mat-icon>
                    </button>
                  </div>
                </th>
                <td
                  mat-cell
                  data-label="Storage Unit"
                  *matCellDef="let element; let i = index"
                >
                  <mat-form-field
                    appearance="outline"
                    class="compact-field"
                    style="width: 100%"
                  >
                    <!-- dùng two-way binding để model luôn cập nhật -->
                    <input
                      matInput
                      placeholder="Chọn kho"
                      [(ngModel)]="element.storageUnit"
                      (ngModelChange)="onStorageUnitChange($event, element, i)"
                      [matAutocomplete]="auto"
                      aria-label="storageUnit"
                    />
                    <mat-autocomplete
                      #auto="matAutocomplete"
                      [displayWith]="displayAreaLabel"
                    >
                      <mat-option
                        *ngFor="let opt of filteredStorageOptions[i] | async"
                        [value]="opt.value"
                      >
                        {{ opt.label }}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </td>
              </ng-container>

              <ng-container matColumnDef="trangThai">
                <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
                <td mat-cell data-label="Trạng thái" *matCellDef="let element">
                  {{ element.trangThai }}
                </td>
              </ng-container>

              <ng-container matColumnDef="tenSanPham">
                <th mat-header-cell *matHeaderCellDef>Tên sản phẩm</th>
                <td mat-cell data-label="User Data 3" *matCellDef="let element">
                  {{ element.tenSanPham }}
                </td>
              </ng-container>

              <ng-container matColumnDef="soLuongThung">
                <th mat-header-cell *matHeaderCellDef>Số lượng thùng</th>
                <td
                  mat-cell
                  data-label="Initial Quantity"
                  *matCellDef="let element"
                >
                  {{ element.soLuongThung }}
                </td>
              </ng-container>
              <ng-container matColumnDef="soLuongSp">
                <th mat-header-cell *matHeaderCellDef>Số lượng sản phẩm</th>
                <td
                  mat-cell
                  data-label="Initial Quantity"
                  *matCellDef="let element"
                >
                  {{ element.soLuongSp }}
                </td>
              </ng-container>
              <ng-container matColumnDef="comments">
                <th mat-header-cell *matHeaderCellDef>Comments</th>
                <td mat-cell data-label="Comments" *matCellDef="let element">
                  {{ element.comments }}
                </td>
              </ng-container>
              <ng-container matColumnDef="trangThaiIn">
                <th mat-header-cell *matHeaderCellDef>Trạng thái in</th>
                <td mat-cell data-label="TT in" *matCellDef="let element">
                  <span
                    class="status-badge"
                    [ngClass]="element.printStatus ? 'printed' : 'not-printed'"
                  >
                    {{ element.printStatus ? "Đã in" : "Chưa in" }}
                  </span>
                </td>
              </ng-container>
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Tuỳ chọn</th>
                <td
                  mat-cell
                  data-label=""
                  *matCellDef="let element; let i = index"
                >
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="openGroupDetailDialog(element)"
                    matTooltip="Xem chi tiết"
                    matTooltipPosition="left"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="deleteReelGroup(i)"
                    [disabled]="element.printStatus"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <ng-container matColumnDef="sapCode">
                <th mat-header-cell *matHeaderCellDef>SAP Code</th>
                <td mat-cell data-label="SAP Code" *matCellDef="let element">
                  {{ element.sapCode }}
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="reelColumns; sticky: true"
              ></tr>
              <tr mat-row *matRowDef="let row; columns: reelColumns"></tr>
            </table>
            <!-- Mobile card view -->
            <div class="tem-cards-mobile d-md-none">
              <div
                class="tem-card-mobile"
                *ngFor="let element of reelGroups; let i = index"
              >
                <div class="card-header">
                  <span class="card-number">#{{ i + 1 }}</span>
                  <span class="card-status">{{ element.trangThai }}</span>
                </div>
                <div class="card-body">
                  <div class="card-info-grid">
                    <div class="info-item">
                      <span class="info-label">Part Number</span>
                      <span class="info-value" [title]="element.partNumber">{{
                        element.partNumber
                      }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Lot</span>
                      <span class="info-value">{{ element.lot }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">SL Thùng</span>
                      <span class="info-value">{{ element.soLuongThung }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">SL SP</span>
                      <span class="info-value">{{ element.soLuongSp }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">SAP Code</span>
                      <span class="info-value">{{ element.sapCode }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Created</span>
                      <span class="info-value">{{
                        element.createdAt | date: "MM-dd HH:mm"
                      }}</span>
                    </div>
                  </div>

                  <div class="card-storage">
                    <div class="storage-label">Kho</div>
                    <div class="storage-value">
                      {{ element.storageUnit || "Chưa chọn" }}
                    </div>
                  </div>

                  <div class="card-actions">
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="openGroupDetailDialog(element)"
                    >
                      <mat-icon>visibility</mat-icon>
                      Chi tiết
                    </button>
                    <button
                      mat-stroked-button
                      color="warn"
                      (click)="deleteReelGroup(i)"
                    >
                      <mat-icon>delete</mat-icon>
                      Xóa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <div class="pakage-button desktop-only">
      <button
        mat-raised-button
        color="primary"
        class="add-box-btn"
        (click)="openCreateBoxDialog()"
      >
        <mat-icon>add</mat-icon>
        Tạo thùng mới
      </button>
      <button
        mat-raised-button
        color="primary"
        class="add-box-btn"
        (click)="openCreatePalletDialog()"
      >
        <mat-icon>add</mat-icon>
        Tạo Pallet mới
      </button>
      <button
        mat-raised-button
        color="primary"
        class="add-box-btn"
        (click)="printAllPallets()"
      >
        <mat-icon>print</mat-icon>
        In tất cả
      </button>
      <button mat-raised-button color="primary" (click)="exportAllQRCodesPdf()">
        Xuất QR Box (TP)
      </button>
      <button
        mat-raised-button
        color="accent"
        (click)="openPackagePalletDialog()"
      >
        <mat-icon>qr_code_scanner</mat-icon>
        Pakage (Đóng gói)
      </button>
    </div>
  </div>

  <div class="pakage-button mobile-fab" [class.open]="fabMenuOpen">
    <button
      mat-fab
      color="primary"
      (click)="toggleFabMenu()"
      matTooltip="Menu"
      matTooltipPosition="left"
    >
      <mat-icon>{{ fabMenuOpen ? "close" : "menu" }}</mat-icon>
    </button>

    <button
      mat-fab
      class="add-box-btn"
      (click)="openCreateBoxDialog(); toggleFabMenu()"
      matTooltip="Tạo Box"
      matTooltipPosition="left"
    >
      <mat-icon>view_in_ar</mat-icon>
    </button>

    <button
      mat-fab
      class="add-box-btn"
      (click)="openCreatePalletDialog(); toggleFabMenu()"
      matTooltip="Tạo Pallet"
      matTooltipPosition="left"
    >
      <mat-icon>layers</mat-icon>
    </button>

    <button
      mat-fab
      color="primary"
      class="add-box-btn"
      (click)="printAllPallets(); toggleFabMenu()"
      matTooltip="In tất cả"
      matTooltipPosition="left"
    >
      <mat-icon>print</mat-icon>
    </button>

    <button
      mat-fab
      color="accent"
      (click)="openPackagePalletDialog(); toggleFabMenu()"
      matTooltip="Đóng gói"
      matTooltipPosition="left"
    >
      <mat-icon>qr_code_scanner</mat-icon>
    </button>
  </div>

  <div class="footer-button">
    <button
      mat-raised-button
      color="basic"
      [routerLink]="'/warehouse-note-infos'"
    >
      <mat-icon>arrow_back</mat-icon>
      Trở lại
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="onComplete(maLenhSanXuatId!)"
    >
      <mat-icon>done_all</mat-icon>
      Hoàn thành
    </button>

    <button mat-raised-button color="primary" (click)="onApprove()">
      <mat-icon>check_circle_outline</mat-icon>
      {{ isThanhPham ? "Gửi phê duyệt WMS" : "Gửi phê duyệt" }}
    </button>
  </div>
</div>
