<div class="dialog-wrapper">
  <!-- Dialog Header (No Print) -->
  <div class="dialog-header no-print">
    <h2>Print Preview - {{ pallets.length }} phiếu ({{ totalPages }} trang)</h2>
    <div class="header-actions">
      <!-- Paper Size Selector -->
      <mat-form-field appearance="outline" class="paper-size-selector">
        <mat-label>Kích thước</mat-label>
        <mat-select
          [(value)]="paperSize"
          (selectionChange)="onPaperSizeChange()"
        >
          <mat-option value="A4">A4 (2 phiếu/trang)</mat-option>
          <mat-option value="A5">A5 (1 phiếu/trang)</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="accent" (click)="onExportPdf()">
        <mat-icon>picture_as_pdf</mat-icon>
        Xuất PDF
      </button>
      <button mat-raised-button color="primary" (click)="onPrint()">
        <mat-icon>print</mat-icon>
        Print
      </button>
      <button mat-icon-button (click)="onClose()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
  <div class="progress-bar-wrapper" *ngIf="isLoadingPdf">
    <mat-progress-bar
      mode="determinate"
      [value]="progressPdf"
    ></mat-progress-bar>
    <span class="progress-text">Đang xuất PDF: {{ progressPdf }}%</span>
  </div>
  <!-- Print Content - Grouped by rows of 2 -->
  <div class="print-content" [class.a5-mode]="paperSize === 'A5'">
    <!-- ===== LOOP QUA TỪNG TRANG ===== -->
    <div
      class="print-page"
      *ngFor="let page of displayPages; let pageIndex = index"
    >
      <!-- ===== PHIẾU BÊN TRÁI (hoặc duy nhất nếu A5) ===== -->
      <div class="pallet-card" *ngIf="page.left">
        <!-- Top Section with QR Code and Title -->
        <div class="top-section">
          <div class="qr-code-wrapper">
            <qrcode
              [qrdata]="page.left.serialPallet"
              [width]="95"
              [margin]="1"
              [colorDark]="'#000000'"
              [colorLight]="'#FFFFFF'"
            ></qrcode>
          </div>
          <div class="title-wrapper">
            <h1>PHIẾU THÔNG TIN</h1>
          </div>
        </div>

        <!-- Main Info Table -->
        <table class="info-table">
          <tbody>
            <tr>
              <td class="label-cell">Khách hàng</td>
              <td class="value-cell text-bold" colspan="3">
                {{ page.left.khachHang }}
              </td>
            </tr>
            <tr>
              <td class="label-cell">Serial pallet</td>
              <td class="value-cell" colspan="3">
                {{ page.left.serialPallet }}
              </td>
            </tr>
            <tr>
              <td class="label-cell">Tên sản phẩm</td>
              <td class="value-cell" colspan="3">{{ page.left.tenSanPham }}</td>
            </tr>
            <tr>
              <td class="label-cell">PO Number</td>
              <td class="value-cell po-number" colspan="3">
                {{ page.left.poNumber }}
              </td>
            </tr>
            <!-- ROW: Item No/SKU | Ngành -->
            <tr>
              <td class="label-cell">Item No/SKU</td>
              <td class="value-cell">{{ page.left.itemNoSku }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Ngành:</span>
                  <span class="sub-value">{{ page.left.led2 }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số QDSX | Tổ -->
            <tr>
              <td class="label-cell">Số QDSX</td>
              <td class="value-cell">{{ page.left.soQdsx }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Tổ:</span>
                  <span class="sub-value">{{ page.left.to }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Ngày sản xuất | Date Code -->
            <tr>
              <td class="label-cell">Ngày sản xuất</td>
              <td class="value-cell">{{ page.left.ngaySanXuat }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Date Code:</span>
                  <span class="sub-value">{{ page.left.dateCode }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số lượng (sản phẩm/pallet) | SL sản phẩm/Thùng -->
            <tr>
              <td class="label-cell">Số lượng<br />(sản phẩm/pallet)</td>
              <td class="value-cell text-bold">
                {{ page.left.soLuongCaiDatPallet }}
              </td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">SL SP/Thùng:</span>
                  <span class="sub-value">{{ page.left.slThung }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số lượng (thùng/pallet) | Thứ tự giá pallet -->
            <tr>
              <td class="label-cell">Số lượng<br />(thùng/pallet)</td>
              <td class="value-cell text-bold">
                {{ page.left.soLuongBaoNgoaiThungGiaPallet }}
              </td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Thứ tự giá:</span>
                  <span class="sub-value">{{ page.left.thuTuGiaPallet }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Người kiểm tra | Kết quả kiểm tra -->
            <tr>
              <td class="label-cell">Người kiểm tra</td>
              <td class="value-cell">{{ page.left.nguoiKiemTra }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">KQ kiểm tra:</span>
                  <span class="sub-value">{{ page.left.ketQuaKiemTra }}</span>
                </div>
              </td>
            </tr>
            <tr>
              <td class="label-cell">Ghi chú</td>
              <td class="value-cell text-note" colspan="3">
                {{ page.left.note }}
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Bottom Section -->
        <div class="bottom-section">
          <div class="qr-code-wrapper">
            <qrcode
              [qrdata]="page.left.serialBox"
              [width]="95"
              [margin]="1"
              [colorDark]="'#000000'"
              [colorLight]="'#FFFFFF'"
            ></qrcode>
          </div>
          <div class="product-info">
            <div class="info-row">
              <span class="info-label">Product Code:</span>
              <span class="info-value">{{ page.left.productCode }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Serial Box:</span>
              <span class="info-value">{{ page.left.serialBox }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Qty:</span>
              <span class="info-value">{{ page.left.qty }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Lot:</span>
              <span class="info-value">{{ page.left.lot }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Date:</span>
              <span class="info-value">{{ page.left.date }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== PHIẾU BÊN PHẢI (chỉ hiện khi A4 mode) ===== -->
      <div class="pallet-card" *ngIf="page.right && paperSize === 'A4'">
        <!-- Top Section -->
        <div class="top-section">
          <div class="qr-code-wrapper">
            <qrcode
              [qrdata]="page.right.serialPallet"
              [width]="95"
              [margin]="1"
              [colorDark]="'#000000'"
              [colorLight]="'#FFFFFF'"
            ></qrcode>
          </div>
          <div class="title-wrapper">
            <h1>PHIẾU THÔNG TIN</h1>
          </div>
        </div>

        <!-- Main Info Table -->
        <table class="info-table">
          <tbody>
            <tr>
              <td class="label-cell">Khách hàng</td>
              <td class="value-cell text-bold" colspan="3">
                {{ page.right.khachHang }}
              </td>
            </tr>
            <tr>
              <td class="label-cell">Serial pallet</td>
              <td class="value-cell" colspan="3">
                {{ page.right.serialPallet }}
              </td>
            </tr>
            <tr>
              <td class="label-cell">Tên sản phẩm</td>
              <td class="value-cell" colspan="3">
                {{ page.right.tenSanPham }}
              </td>
            </tr>
            <tr>
              <td class="label-cell">PO Number</td>
              <td class="value-cell po-number" colspan="3">
                {{ page.right.poNumber }}
              </td>
            </tr>
            <!-- ROW: Item No/SKU | Ngành -->
            <tr>
              <td class="label-cell">Item No/SKU</td>
              <td class="value-cell">{{ page.right.itemNoSku }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Ngành:</span>
                  <span class="sub-value">{{ page.right.led2 }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số QDSX | Tổ -->
            <tr>
              <td class="label-cell">Số QDSX</td>
              <td class="value-cell">{{ page.right.soQdsx }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Tổ:</span>
                  <span class="sub-value">{{ page.right.to }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Ngày sản xuất | Date Code -->
            <tr>
              <td class="label-cell">Ngày sản xuất</td>
              <td class="value-cell">{{ page.right.ngaySanXuat }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Date Code:</span>
                  <span class="sub-value">{{ page.right.dateCode }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số lượng (sản phẩm/pallet) | SL sản phẩm/Thùng -->
            <tr>
              <td class="label-cell">Số lượng<br />(sản phẩm/pallet)</td>
              <td class="value-cell text-bold">
                {{ page.right.soLuongCaiDatPallet }}
              </td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">SL SP/Thùng:</span>
                  <span class="sub-value">{{ page.right.slThung }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Số lượng (thùng/pallet) | Thứ tự giá pallet -->
            <tr>
              <td class="label-cell">Số lượng<br />(thùng/pallet)</td>
              <td class="value-cell text-bold">
                {{ page.right.soLuongBaoNgoaiThungGiaPallet }}
              </td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">Thứ tự giá:</span>
                  <span class="sub-value">{{ page.right.thuTuGiaPallet }}</span>
                </div>
              </td>
            </tr>
            <!-- ROW: Người kiểm tra | Kết quả kiểm tra -->
            <tr>
              <td class="label-cell">Người kiểm tra</td>
              <td class="value-cell">{{ page.right.nguoiKiemTra }}</td>
              <td class="split-cell" colspan="2">
                <div class="split-content">
                  <span class="sub-label">KQ kiểm tra:</span>
                  <span class="sub-value">{{ page.right.ketQuaKiemTra }}</span>
                </div>
              </td>
            </tr>
            <tr>
              <td class="label-cell">Ghi chú</td>
              <td class="value-cell text-note" colspan="3">
                {{ page.right.note }}
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Bottom Section -->
        <div class="bottom-section">
          <div class="qr-code-wrapper">
            <qrcode
              [qrdata]="page.right.serialBox"
              [width]="95"
              [margin]="1"
              [colorDark]="'#000000'"
              [colorLight]="'#FFFFFF'"
            ></qrcode>
          </div>
          <div class="product-info">
            <div class="info-row">
              <span class="info-label">Product Code:</span>
              <span class="info-value">{{ page.right.productCode }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Serial Box:</span>
              <span class="info-value">{{ page.right.serialBox }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Qty:</span>
              <span class="info-value">{{ page.right.qty }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Lot:</span>
              <span class="info-value">{{ page.right.lot }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Date:</span>
              <span class="info-value">{{ page.right.date }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ===== END PAGE LOOP ===== -->
  </div>
</div>
