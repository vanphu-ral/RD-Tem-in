<div class="dialog-header">
  <h2 mat-dialog-title class="dialog-title">Cập nhật vật tư</h2>
  <div style="align-items: center">
    <!-- <button
      mat-raised-button
      [matMenuTriggerFor]="menu"
      class="custom-approver-button"
    >
      <span class="button-text">
        {{ selectedApprover()
          ? (selectedApprover()!.firstName + ' ' + selectedApprover()!.lastName)
          : 'Chọn người duyệt'
        }}
      </span>
      <mat-icon class="button-icon">keyboard_arrow_down</mat-icon>
    </button>

    <mat-menu #menu="matMenu">
      <div style="max-height: 300px; overflow-y: auto; min-width: 220px; padding: 8px;">
        <mat-radio-group
          [value]="selectedApprover()"
          (change)="onSelectApprover($event.value)"
        >
          <mat-radio-button
            *ngFor="let user of approvers(); let i = index"
            [value]="user"
            style="display: block; margin: 4px 0; padding-left: 16px;"
          >
            {{ user.firstName }} {{ user.lastName }}
            <small style="opacity: .7">({{ user.username }})</small>
          </mat-radio-button>
        </mat-radio-group>
      </div>
    </mat-menu> -->
    <mat-form-field appearance="fill">
      <mat-label>Chọn người duyệt</mat-label>

      <input
        type="text"
        matInput
        [formControl]="approverCtrl"
        [matAutocomplete]="auto"
        placeholder="Nhập mã người duyệt"
      />

      <mat-autocomplete
        #auto="matAutocomplete"
        [displayWith]="displayApprover"
        (optionSelected)="onApproverSelected($event.option.value)"
      >
        <mat-option *ngFor="let u of filteredApprovers | async" [value]="u">
          {{ u.username }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
  </div>

  <!-- <div style="display: flex; align-items: center; margin-top: 10px;">
    <form [formGroup]="dialogForm" style="width: 200px;">
      <mat-form-field class="example-full-width">
        <mat-label>Chọn kho</mat-label>
        <input type="text" placeholder="Nhập để chọn kho" matInput formControlName="selectedWarehouseControl"
          [matAutocomplete]="autoWarehouse">
        <mat-autocomplete #autoWarehouse="matAutocomplete" [displayWith]="displayWarehouseFn"
          (optionSelected)="globalWarehouseChanged($event.option.value)">
          @for (warehouse of filteredWarehouses | async; track warehouse.value) {
          <mat-option [value]="warehouse">{{warehouse.name}}</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
    </form>
  </div> -->
</div>

<mat-dialog-content class="mat-typography">
  <div>
    <table
      mat-table
      [dataSource]="itemsDataSource"
      class="mat-elevation-z8 bordered-table"
    >
      <ng-container matColumnDef="materialIdentifier">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="search-header"
          style="background-color: #548ce8"
        >
          <div class="header-content">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div class="column-title" style="color: white">
                Material Identifier
              </div>
              <div>
                <mat-icon
                  [matMenuTriggerFor]="filterMenuIndentify"
                  style="color: white"
                  >filter_list</mat-icon
                >
              </div>
            </div>
            <mat-menu #filterMenuIndentify="matMenu">
              <button
                mat-menu-item
                (click)="setFilterMode( 'materialIdentifier' , 'contains')"
              >
                Có chứa
              </button>
              <button
                mat-menu-item
                (click)="setFilterMode( 'materialIdentifier' , 'equals')"
              >
                Bằng
              </button>
            </mat-menu>
            <div class="search-container">
              <div class="custom-search-wrapper">
                <input
                  type="text"
                  class="custom-search-input"
                  [placeholder]="'Search (' + (filterModes['materialIdentifier'] || 'contains') + ')'"
                  style="width: 100%"
                  (keyup)="applyFilter('materialIdentifier',$event)"
                />
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          {{element['materialIdentifier']}}
        </td>
      </ng-container>

      <ng-container matColumnDef="partNumber">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  color: white;
                "
              >
                <div class="column-title">Part Number</div>
                <div>
                  <mat-icon
                    [matMenuTriggerFor]="filterPartNumber"
                    style="color: white"
                    >filter_list</mat-icon
                  >
                </div>
              </div>
              <mat-menu #filterPartNumber="matMenu">
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'partNumber' , 'contains')"
                >
                  Có chứa
                </button>
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'partNumber' , 'equals')"
                >
                  Bằng
                </button>
              </mat-menu>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <input
                    type="text"
                    class="custom-search-input"
                    [placeholder]="'Search (' + (filterModes['partNumber'] || 'contains') + ')'"
                    (keyup)="applyFilter('partNumber',$event)"
                  />
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">{{element['partNumber']}}</td>
      </ng-container>

      <ng-container matColumnDef="expirationDate">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  color: white;
                "
              >
                <div class="column-title">Ngày hết hạn</div>
                <div>
                  <mat-icon
                    [matMenuTriggerFor]="filterExpirationDate"
                    style="color: white"
                    >filter_list</mat-icon
                  >
                </div>
              </div>
              <mat-menu #filterExpirationDate="matMenu">
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'expirationDate' , 'contains')"
                >
                  Có chứa
                </button>
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'expirationDate' , 'equals')"
                >
                  Bằng
                </button>
              </mat-menu>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <input
                    type="text"
                    class="custom-search-input"
                    [placeholder]="'Search (' + (filterModes['expirationDate'] || 'contains') + ')'"
                    (keyup)="applyFilter('expirationDate',$event)"
                  />
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          {{element['expirationDate'] | timestampToDate }}
        </td>
      </ng-container>
      <ng-container matColumnDef="calculatedStatus">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="background-color: #548ce8; max-width: 130px"
        >
          <div class="th-container">
            <div class="header-content">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  color: white;
                "
              >
                <div class="column-title">Status</div>
                <div>
                  <mat-icon
                    [matMenuTriggerFor]="filterMenuCalculatedStatus"
                    style="color: white"
                    >filter_list</mat-icon
                  >
                </div>
              </div>
              <mat-menu #filterMenuCalculatedStatus="matMenu">
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'calculatedStatus' , 'contains')"
                >
                  Có chứa
                </button>
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'calculatedStatus' , 'equals')"
                >
                  Bằng
                </button>
              </mat-menu>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <mat-form-field
                    class="small-form-field"
                    appearance="fill"
                    floatLabel="always"
                  >
                    <mat-label>Search Status</mat-label>
                    <mat-select
                      placeholder="Search"
                      (selectionChange)="applySelectFilter('calculatedStatus', $event.value)"
                    >
                      <mat-option
                        *ngFor="let opt of statusOptions"
                        [value]="opt.value"
                      >
                        {{ opt.view }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          {{element['calculatedStatus']}}
        </td>
      </ng-container>

      <ng-container matColumnDef="extendExpiration">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  color: white;
                "
              >
                <div class="column-title">Gia hạn</div>
              </div>
              <div class="search-container">
                <div class="custom-search-wrapper text-center">
                  <mat-checkbox
                    color="primary"
                    (change)="toggleAllExtendExpiration($event.checked)"
                    [checked]="isAllExtendExpirationSelected()"
                    [indeterminate]="isSomeExtendExpirationSelected()"
                  >
                  </mat-checkbox>
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element" class="text-center">
          <mat-checkbox
            color="primary"
            [(ngModel)]="element.extendExpiration"
            (ngModelChange)="element._isChanged = true"
          >
          </mat-checkbox>
        </td>
      </ng-container>
      <!-- <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef style="background-color:#548CE8">
          <div class="th-container">
            <div class="header-content">
              <div style="display: flex; align-items: center; justify-content: space-between; color: white;">
                <div class="column-title">
                  Status
                </div>
                <div>
                  <mat-icon [matMenuTriggerFor]="filterquantity" style="color: white;">filter_list</mat-icon>
                </div>
              </div>
              <mat-menu #filterquantity="matMenu">
                <button mat-menu-item (click)="setFilterMode('status' , 'contains')">Contains</button>
                <button mat-menu-item (click)="setFilterMode('status' , 'not_contains')">Does
                  not
                  contain</button>
                <button mat-menu-item (click)="setFilterMode('status' , 'equals')">Equals</button>
                <button mat-menu-item (click)="setFilterMode('status' , 'not_equals')">Does not
                  equal</button>
              </mat-menu>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <mat-form-field class="small-form-field" appearance="fill" floatLabel="always">
                    <mat-label>Search Status</mat-label>
                    <mat-select placeholder="Search" (selectionChange)="applySelectFilter('status', $event.value)">
                      <mat-option *ngFor="let opt of statusOptions" [value]="opt.value">
                        {{ opt.view }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </th> -->
      <!-- <td mat-cell *matCellDef="let element">
          {{ element['status'] | statusLabel }}
        </td> -->
      <!-- <td mat-cell *matCellDef="let element">
          {{ element | json }}
        </td> -->

      <!-- </ng-container> -->

      <!-- Phần header -->
      <ng-container matColumnDef="locationId">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content" style="color: white">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <div class="column-title">Tên kho</div>
              </div>
              <div class="search-container">
                <div class="custom-search-wrapper" style="width: 100%">
                  <form style="width: 100%" [formGroup]="dialogForm">
                    <!-- Header dùng binding riêng -->
                    <input
                      class="editable-cell"
                      type="text"
                      placeholder="Chọn kho cho tất cả"
                      aria-label="Kho"
                      matInput
                      formControlName="selectedWarehouseControl"
                      [matAutocomplete]="autoWarehouse"
                    />

                    <mat-autocomplete
                      #autoWarehouse="matAutocomplete"
                      [displayWith]="displayWarehouseFn"
                      (optionSelected)="globalWarehouseChanged($event.option.value)"
                    >
                      <!-- Sử dụng danh sách từ filteredlocations -->
                      @for (warehouse of filteredWarehouses | async; track
                      warehouse.value) {
                      <mat-option [value]="warehouse"
                        >{{ warehouse.name }}</mat-option
                      >
                      }
                    </mat-autocomplete>
                  </form>
                </div>
                <mat-spinner
                  *ngIf="scanLoadingAll"
                  diameter="20"
                  style="margin-left: 8px"
                ></mat-spinner>
              </div>
            </div>
          </div>
        </th>

        <!-- Phần cell mỗi dòng -->
        <td mat-cell *matCellDef="let element">
          <div style="display: flex; align-items: center">
            <form
              [formGroup]="getFormGroupForItem(element)"
              style="width: 100%"
            >
              <input
                class="editable-cell"
                type="text"
                placeholder="Chọn kho mới"
                aria-label="Kho"
                matInput
                formControlName="selectedWarehouseItem"
                [matAutocomplete]="autoWarehouseRow"
                #rowTrigger="matAutocompleteTrigger"
                (focus)="openRowPanel(rowTrigger)"
                [disabled]="!isWarehouseReady || scanLoadingRow[element.materialIdentifier]"
              />

              <mat-autocomplete
                #autoWarehouseRow="matAutocomplete"
                [displayWith]="displayWarehouseFn"
                (optionSelected)="rowWarehouseChanged($event.option.value, element)"
              >
                <mat-option
                  *ngFor="let warehouse of (rowFilteredWarehouses.get(element.materialIdentifier) | async)"
                  [value]="warehouse"
                >
                  {{ warehouse.name }}
                </mat-option>
              </mat-autocomplete>
            </form>

            <mat-spinner
              *ngIf="!isWarehouseReady || scanLoadingRow[element.materialIdentifier]"
              diameter="20"
              style="margin-left: 8px"
            />
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content" style="color: white">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <div class="column-title">Số lượng hiện có</div>
                <div>
                  <mat-icon
                    style="color: white"
                    [matMenuTriggerFor]="filterMenuQuantity"
                    >filter_list</mat-icon
                  >
                </div>
              </div>
              <mat-menu #filterMenuQuantity="matMenu">
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'quantity' , 'contains')"
                >
                  Có chứa
                </button>
                <button
                  mat-menu-item
                  (click)="setFilterMode( 'quantity' , 'equals')"
                >
                  Bằng
                </button>
              </mat-menu>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <input
                    type="text"
                    class="custom-search-input"
                    placeholder="Search"
                    (keyup)="applyFilter('quantity',$event)"
                  />
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">{{element['quantity']}}</td>
      </ng-container>

      <ng-container matColumnDef="quantityChange">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <div class="th-container">
            <div class="header-content" style="color: white">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <div class="column-title">Số lượng điều chỉnh</div>
                <!-- <div>
                  <mat-icon style="color: white;">filter_list</mat-icon>
                </div> -->
              </div>
              <div class="search-container">
                <div class="custom-search-wrapper">
                  <!-- <input
                    #hdrInput
                    type="number"
                    class="custom-search-input"
                    placeholder="Nhập số để áp dụng cho tất cả"
                    [(ngModel)]="headerQuantityChange"
                    (input)="clampHeaderQuantity(hdrInput)"
                    (keyup.enter)="applyHeaderQuantityChange()"
                    (blur)="applyHeaderQuantityChange()"
                  /> -->
                  <input
                    #hdrInput
                    type="number"
                    class="custom-search-input"
                    placeholder="Nhập số cho tất cả"
                    [(ngModel)]="headerQuantityChange"
                    (keyup.enter)="applyHeaderQuantityChange()"
                  />
                </div>
              </div>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element">
          <input
            matInput
            type="number"
            class="editable-cell"
            [(ngModel)]="element.quantityChange"
          />
        </td>
      </ng-container>
      <ng-container matColumnDef="scanLocation">
        <th mat-header-cell *matHeaderCellDef style="background-color: #548ce8">
          <button mat-raised-button (click)="scanLocationForAll()">
            <mat-icon>center_focus_weak</mat-icon> Scan
          </button>
          <button mat-raised-button (click)="refreshForAll()">
            <mat-icon>refresh</mat-icon> Fresh
          </button>
          <!-- <mat-spinner *ngIf="scanLoadingAll" diameter="20" style="margin-left: 8px"></mat-spinner> -->
        </th>
        <td mat-cell *matCellDef="let element" class="text-center">
          <button mat-raised-button (click)="scanLocationForRow(element)">
            <mat-icon>center_focus_weak</mat-icon> Scan
          </button>
          <button mat-raised-button (click)="refreshForRow(element)">
            <mat-icon>refresh</mat-icon> Fresh
          </button>
          <!-- <mat-spinner *ngIf="scanLoadingRow[element.materialIdentifier]" diameter="20"
            style="margin-left: 8px"></mat-spinner> -->
        </td>
      </ng-container>
      <!-- <ng-container matColumnDef="Gia hạn">
        <th mat-header-cell *matHeaderCellDef style="background-color:#548CE8;">
          <div class="th-container">
            <div class="header-content"
              style="color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding-top: 5px; padding-bottom: 5px;">
              <div class="column-title" style="margin-bottom: 5px; text-align: center;">
                Gia hạn
              </div>
              <mat-checkbox color="primary" (change)="toggleAllExtendExpiration($event.checked)"
                [checked]="isAllExtendExpirationSelected()" [indeterminate]="isSomeExtendExpirationSelected()"
                aria-label="Chọn/Bỏ chọn tất cả gia hạn">
              </mat-checkbox>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let element" style="text-align: center;">
          <mat-checkbox color="primary" [(ngModel)]="element.extendExpiration"
            (ngModelChange)="element._isChanged = true" aria-label="Gia hạn vật tư này">
          </mat-checkbox>
        </td>
      </ng-container> -->

      <tr mat-header-row *matHeaderRowDef="displayedColumns sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
    <input
      #scanInput
      type="text"
      style="position: absolute; opacity: 0"
      (input)="onScanLocationInput(scanInput.value)"
      (keydown.enter)="onScanInputEnter($event)"
      autocomplete="off"
    />
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-footer">
  <span class="dialog-notice"
    >Nếu chọn gia hạn, hệ thống sẽ tự động gia hạn thêm 15 ngày.</span
  >
  <div>
    <button mat-button (click)="onCancel()">Hủy</button>
    <button mat-stroked-button class="dialog-accept-btn" (click)="onSave()">
      Gửi đề nghị
    </button>
  </div>
</mat-dialog-actions>
