<div class="container mat-elevation-z2">
  <!-- Header -->
  <div class="mb-4">
    <h2>Chi tiết thông tin vật tư</h2>
  </div>

  <!-- Toolbar -->
  <mat-toolbar class="mb-3 mat-elevation-z2">
    <div class="d-flex justify-content-between w-100">
      <!-- Trái -->
      <div class="d-flex align-items-center">
        <button mat-icon-button (click)="goBack()" class="mr-3">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="mat-title">
          <span>Danh sách vật tư của PO:</span>
          <span class="po-number">{{ poNumber }}</span>
        </div>
      </div>

      <!-- Phải -->
      <div class="d-flex align-items-center gap-3">
        <!-- Nhập kho -->
        <mat-form-field
          appearance="outline"
          class="small-form-field"
          style="width: 250px; margin-bottom: -24px"
        >
          <mat-label>Nhập tên kho...</mat-label>
          <input
            type="text"
            matInput
            [(ngModel)]="selectedStorageUnit"
            [matAutocomplete]="auto"
            (input)="filterStorageUnits()"
            autocomplete="off"
          />
          <mat-autocomplete
            #auto="matAutocomplete"
            (optionSelected)="onSelectUnit($event.option.value)"
          >
            <mat-option *ngFor="let unit of filteredUnits" [value]="unit">
              {{ unit }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- Nút hành động -->
        <button
          mat-raised-button
          color="primary"
          (click)="onGenerateTemForRequest(requestId)"
          [disabled]="isDisableGenerate"
        >
          Generate tem in
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="saveLocation()"
          [disabled]="isDisableInputLocation"
        >
          Lưu
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="openCsvPreview()"
          matTooltip="Xuất Excel"
          [disabled]="isDisable"
        >
          <fa-icon [icon]="faFileCsv"></fa-icon>
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="exportCsvToFixedIP()"
          matTooltip="Xuất CSV đến server"
          [disabled]="isDisable"
        >
          <mat-icon>system_update_alt</mat-icon>
        </button>
        <span
          matTooltip="Cần generate tem trước"
          [matTooltipDisabled]="!isDisable"
          matTooltipPosition="above"
        >
          <button
            mat-raised-button
            color="primary"
            (click)="openPrintPreviewAll(requestId)"
            matTooltip="In tất cả tem"
            [disabled]="isDisable"
          >
            <fa-icon [icon]="faPrint"></fa-icon>
          </button>
        </span>
      </div>
    </div>
  </mat-toolbar>

  <!-- Table -->
  <div class="table-container">
    <table
      mat-table
      [dataSource]="pagedMaterials"
      matSort
      class="mat-elevation-z1"
    >
      <!-- STT Column -->
      <ng-container matColumnDef="stt">
        <th mat-header-cell *matHeaderCellDef style="width: 50px">STT</th>
        <td mat-cell *matCellDef="let item; let i = index" class="text-center">
          {{ materialCurrentPage * materialPageSize + i + 1 }}
        </td>
      </ng-container>

      <!-- Thao tác Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef style="min-width: 300px">
          Thao tác
        </th>
        <td mat-cell *matCellDef="let item; let index = index">
          <div class="action-buttons">
            <button
              mat-icon-button
              color="primary"
              (click)="onAction('view', item, index)"
              matTooltip="Xem chi tiết"
            >
              <mat-icon>visibility</mat-icon>
            </button>

            <button
              *ngIf="!item.isEditing"
              mat-icon-button
              color="accent"
              (click)="onAction('edit', item, index)"
              matTooltip="Chỉnh sửa"
              [disabled]="!isDisable"
            >
              <mat-icon>edit</mat-icon>
            </button>

            <button
              *ngIf="item.isEditing"
              mat-icon-button
              color="primary"
              [disabled]="item.isSaving"
              (click)="onAction('confirm', item, index)"
              matTooltip="Xác nhận"
            >
              <mat-icon>check_circle</mat-icon>
            </button>

            <button
              mat-icon-button
              color="warn"
              (click)="onAction('delete', item, index)"
              matTooltip="Xóa"
            >
              <mat-icon>delete</mat-icon>
            </button>

            <button
              mat-icon-button
              (click)="onAction('exportCsv', item, index)"
              matTooltip="Xuất CSV"
              [disabled]="isDisable"
            >
              <fa-icon [icon]="faFileCsv" size="xs"></fa-icon>
            </button>
            <!-- <button
              mat-icon-button
              (click)="exportSingleProductCsvToFixedIP(item.id)"
              matTooltip="Xuất CSV đến server"
              [disabled]="isDisable"
              color="accent"
            > -->
            <button
              mat-icon-button
              (click)="onAction('exportCsvToFixedIP', item, index)"
              matTooltip="Xuất CSV đến server"
              [disabled]="isDisable"
              color="accent"
            >
              <mat-icon>system_update_alt</mat-icon>
            </button>
            <span
              matTooltip="Cần generate tem trước"
              [matTooltipDisabled]="!isDisable"
              matTooltipPosition="above"
            >
              <button
                mat-icon-button
                (click)="onAction('print', item, index)"
                matTooltip="In tem"
                [disabled]="isDisable"
              >
                <mat-icon>local_printshop</mat-icon>
              </button>
            </span>

            <button mat-icon-button color="primary" matTooltip="Scan">
              <mat-icon>qr_code_scanner</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Lần in Column -->
      <ng-container matColumnDef="numberOfPrints">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Lần in</th>
        <td mat-cell *matCellDef="let item" class="text-center">
          {{ item.numberOfPrints }}
        </td>
      </ng-container>

      <!-- SAPCode Column -->
      <ng-container matColumnDef="sapCode">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>SAPCode</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewSapCode">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.sapCode" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewSapCode>
            {{ item.sapCode }}
          </ng-template>
        </td>
      </ng-container>

      <!-- Mã PO Column -->
      <ng-container matColumnDef="userData5">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Mã PO</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewUserData5">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.userData5" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewUserData5>
            {{ item.userData5 }}
          </ng-template>
        </td>
      </ng-container>

      <!-- PartNumber Column -->
      <ng-container matColumnDef="partNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>PartNumber</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewPartNumber">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.partNumber" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewPartNumber>
            {{ item.partNumber }}
          </ng-template>
        </td>
      </ng-container>

      <!-- LOT Column -->
      <ng-container matColumnDef="lot">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>LOT</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewLot">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.lot" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewLot>
            {{ item.lot }}
          </ng-template>
        </td>
      </ng-container>

      <!-- StorageUnit Column -->
      <ng-container matColumnDef="storageUnit">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>StorageUnit</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewStorageUnit">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.storageUnit" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewStorageUnit>
            {{ item.storageUnit }}
          </ng-template>
        </td>
      </ng-container>

      <!-- Số TEM Column -->
      <ng-container matColumnDef="temQuantity">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Số TEM</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewSoTem">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.temQuantity" type="number" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewSoTem>
            {{ item.temQuantity }}
          </ng-template>
        </td>
      </ng-container>

      <!-- InitialQuantity Column -->
      <ng-container matColumnDef="initialQuantity">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          InitialQuantity
        </th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewInitialQuantity">
            <mat-form-field appearance="outline" class="compact-field">
              <input
                matInput
                [(ngModel)]="item.initialQuantity"
                type="number"
              />
            </mat-form-field>
          </ng-container>
          <ng-template #viewInitialQuantity>
            {{ item.initialQuantity }}
          </ng-template>
        </td>
      </ng-container>

      <!-- Vendor Column -->
      <ng-container matColumnDef="vendor">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Vendor</th>
        <td mat-cell *matCellDef="let item">
          <ng-container *ngIf="item.isEditing; else viewVendor">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput [(ngModel)]="item.vendor" />
            </mat-form-field>
          </ng-container>
          <ng-template #viewVendor>
            {{ item.vendor }}
          </ng-template>
        </td>
      </ng-container>

      <!-- Ngày sản xuất Column -->
      <ng-container matColumnDef="manufacturingDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ngày sản xuất</th>
        <td mat-cell *matCellDef="let item">
          {{ item.manufacturingDate | date: "dd/MM/yyyy" }}
        </td>
      </ng-container>

      <!-- Ngày hết hạn Column -->
      <ng-container matColumnDef="expirationDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ngày hết hạn</th>
        <td mat-cell *matCellDef="let item">
          {{ item.expirationDate | date: "dd/MM/yyyy" }}
        </td>
      </ng-container>

      <!-- Ngày nhập kho Column -->
      <ng-container matColumnDef="arrivalDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ngày nhập kho</th>
        <td mat-cell *matCellDef="let item">
          {{ item.arrivalDate | date: "dd/MM/yyyy" }}
        </td>
      </ng-container>

      <!-- Header & Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [class.editing-row]="row.isEditing"
      ></tr>
    </table>

    <!-- Paginator -->
  </div>
  <mat-divider class="my-3"></mat-divider>
  <mat-paginator
    [length]="materialTotalItems"
    [pageSize]="materialPageSize"
    [pageSizeOptions]="[5, 10, 25, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons
  >
  </mat-paginator>
  <!-- Footer -->
  <!-- <div class="d-flex justify-content-end footer" style="margin-top: 1rem;">
    
  </div> -->
</div>

<!-- Overlay -->
<div class="modal-overlay" *ngIf="showQrModal" (click)="closeQrModal()"></div>

<!-- Material Dialog/Modal -->
<div class="material-modal" *ngIf="showQrModal">
  <mat-card class="modal-card">
    <!-- Header -->
    <mat-card-header class="modal-header-material">
      <mat-card-title>
        <div class="header-content">
          <div class="title-section">
            <mat-icon class="header-icon">qr_code_2</mat-icon>
            <div>
              <h2 class="modal-title-text">Chi Tiết Tem QR</h2>
              <p class="modal-subtitle">
                PartNumber:
                <strong>{{ selectedProductItem?.partNumber }}</strong> | PO:
                <strong>{{ selectedProductItem?.userData5 }}</strong>
              </p>
            </div>
          </div>
          <div>
            <button
              mat-icon-button
              (click)="closeQrModal()"
              class="close-button"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-divider></mat-divider>

    <!-- Body -->
    <mat-card-content class="modal-body-material">
      <!-- Thông tin sản phẩm -->
      <div class="product-info-section">
        <h3 class="section-title">
          <mat-icon class="section-icon">inventory_2</mat-icon>
          Thông Tin Sản Phẩm
        </h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">SAP Code</span>
            <span class="info-value">{{ selectedProductItem?.sapCode }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Part Number</span>
            <span class="info-value">{{
              selectedProductItem?.partNumber
            }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">LOT</span>
            <span class="info-value">{{ selectedProductItem?.lot }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Vendor</span>
            <span class="info-value">{{ selectedProductItem?.vendor }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Số lượng tem</span>
            <mat-chip color="primary" selected>
              {{ temDetailList?.length || 0 }} tem
            </mat-chip>
          </div>
        </div>
      </div>

      <mat-divider class="section-divider"></mat-divider>

      <!-- Loading State -->
      <div *ngIf="isLoadingTemDetails" class="loading-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="loading-text">Đang tải danh sách tem...</p>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="
          !isLoadingTemDetails && (!temDetailList || temDetailList.length === 0)
        "
        class="empty-state"
      >
        <mat-icon class="empty-icon">inbox</mat-icon>
        <p class="empty-text">Chưa có tem nào được tạo cho sản phẩm này</p>
      </div>

      <!-- Danh sách tem -->
      <div
        *ngIf="
          !isLoadingTemDetails && temDetailList && temDetailList.length > 0
        "
        class="table-container-modal"
      >
        <div class="table-scroll-wrapper-view">
          <table
            mat-table
            [dataSource]="temDetailList"
            class="tem-detail-table"
          >
            <!-- STT Column -->
            <ng-container matColumnDef="stt">
              <th mat-header-cell *matHeaderCellDef class="text-center">#</th>
              <td
                mat-cell
                *matCellDef="let item; let i = index"
                class="text-center"
              >
                {{ i + 1 }}
              </td>
            </ng-container>

            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let item">{{ item.id }}</td>
            </ng-container>

            <!-- ReelID Column -->
            <ng-container matColumnDef="reelId">
              <th mat-header-cell *matHeaderCellDef>ReelID</th>
              <td mat-cell *matCellDef="let item">
                <code class="reel-id">{{ item.reelId }}</code>
              </td>
            </ng-container>

            <!-- SAP Code Column -->
            <ng-container matColumnDef="sapCode">
              <th mat-header-cell *matHeaderCellDef>SAP Code</th>
              <td mat-cell *matCellDef="let item">{{ item.sapCode }}</td>
            </ng-container>

            <!-- Tên SP Column -->
            <ng-container matColumnDef="productName">
              <th mat-header-cell *matHeaderCellDef>Tên SP</th>
              <td mat-cell *matCellDef="let item">
                {{ item.productName || "-" }}
              </td>
            </ng-container>

            <!-- Part Number Column -->
            <ng-container matColumnDef="partNumber">
              <th mat-header-cell *matHeaderCellDef>Part Number</th>
              <td mat-cell *matCellDef="let item">{{ item.partNumber }}</td>
            </ng-container>

            <!-- LOT Column -->
            <ng-container matColumnDef="lot">
              <th mat-header-cell *matHeaderCellDef>LOT</th>
              <td mat-cell *matCellDef="let item">{{ item.lot }}</td>
            </ng-container>

            <!-- Số lượng Column -->
            <ng-container matColumnDef="initialQuantity">
              <th mat-header-cell *matHeaderCellDef class="text-right">
                Số lượng
              </th>
              <td mat-cell *matCellDef="let item" class="text-right">
                {{ item.initialQuantity | number }}
              </td>
            </ng-container>

            <!-- Vendor Column -->
            <ng-container matColumnDef="vendor">
              <th mat-header-cell *matHeaderCellDef>Vendor</th>
              <td mat-cell *matCellDef="let item">{{ item.vendor }}</td>
            </ng-container>

            <!-- Rank Màu Column -->
            <ng-container matColumnDef="userData1">
              <th mat-header-cell *matHeaderCellDef>Rank Màu</th>
              <td mat-cell *matCellDef="let item">
                {{ item.userData1 || "-" }}
              </td>
            </ng-container>

            <!-- Rank Áp Column -->
            <ng-container matColumnDef="userData2">
              <th mat-header-cell *matHeaderCellDef>Rank Áp</th>
              <td mat-cell *matCellDef="let item">
                {{ item.userData2 || "-" }}
              </td>
            </ng-container>

            <!-- Rank Quang Column -->
            <ng-container matColumnDef="userData3">
              <th mat-header-cell *matHeaderCellDef>Rank Quang</th>
              <td mat-cell *matCellDef="let item">
                {{ item.userData3 || "-" }}
              </td>
            </ng-container>

            <!-- UserData4 Column -->
            <ng-container matColumnDef="userData4">
              <th mat-header-cell *matHeaderCellDef>UserData4</th>
              <td mat-cell *matCellDef="let item">
                {{ item.userData4 || "-" }}
              </td>
            </ng-container>

            <!-- PO Code Column -->
            <ng-container matColumnDef="userData5">
              <th mat-header-cell *matHeaderCellDef>PO Code</th>
              <td mat-cell *matCellDef="let item">{{ item.userData5 }}</td>
            </ng-container>

            <!-- Kho Column -->
            <ng-container matColumnDef="storageUnit">
              <th mat-header-cell *matHeaderCellDef>Kho</th>
              <td mat-cell *matCellDef="let item">
                <mat-chip color="accent" selected>{{
                  item.storageUnit
                }}</mat-chip>
              </td>
            </ng-container>

            <!-- HSD Column -->
            <ng-container matColumnDef="expirationDate">
              <th mat-header-cell *matHeaderCellDef>HSD</th>
              <td mat-cell *matCellDef="let item">
                {{ item.expirationDate | date: "dd/MM/yyyy" }}
              </td>
            </ng-container>

            <!-- NSX Column -->
            <ng-container matColumnDef="manufacturingDate">
              <th mat-header-cell *matHeaderCellDef>NSX</th>
              <td mat-cell *matCellDef="let item">
                {{ item.manufacturingDate | date: "dd/MM/yyyy" }}
              </td>
            </ng-container>

            <!-- Ngày nhập Column -->
            <ng-container matColumnDef="arrivalDate">
              <th mat-header-cell *matHeaderCellDef>Ngày nhập</th>
              <td mat-cell *matCellDef="let item">
                {{ item.arrivalDate | date: "dd/MM/yyyy" }}
              </td>
            </ng-container>

            <!-- SL Tem Column -->
            <!-- <ng-container matColumnDef="slTemQuantity">
              <th mat-header-cell *matHeaderCellDef class="text-center">
                SL Tem
              </th>
              <td mat-cell *matCellDef="let item" class="text-center">
                {{ item.slTemQuantity || 1 }}
              </td>
            </ng-container> -->

            <!-- QR Code Column -->
            <ng-container matColumnDef="qrCode">
              <th mat-header-cell *matHeaderCellDef>QR Code</th>
              <td mat-cell *matCellDef="let item">
                <code class="qr-code-text">{{ item.qrCode }}</code>
              </td>
            </ng-container>

            <!-- Header & Rows -->
            <tr
              mat-header-row
              *matHeaderRowDef="temDetailColumns; sticky: true"
            ></tr>
            <tr mat-row *matRowDef="let row; columns: temDetailColumns"></tr>
          </table>
        </div>
      </div>
    </mat-card-content>

    <mat-divider></mat-divider>

    <!-- Footer -->
    <mat-card-actions class="modal-footer-material">
      <button mat-raised-button color="primary" (click)="closeQrModal()">
        <mat-icon>close</mat-icon>
        Đóng
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- Overlay -->
<div class="modal-overlay" *ngIf="showCsvModal" (click)="closeCsvModal()"></div>

<!-- CSV Preview Modal -->
<div class="material-modal" *ngIf="showCsvModal">
  <mat-card class="modal-card">
    <!-- Header -->
    <mat-card-header class="csv-modal-header">
      <mat-card-title>
        <div class="header-content">
          <div class="title-section">
            <mat-icon class="header-icon">description</mat-icon>
            <h2 class="modal-title-text">{{ csvFileName }}</h2>
          </div>
          <button
            mat-icon-button
            (click)="closeCsvModal()"
            class="close-button"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-divider></mat-divider>

    <!-- Body -->
    <mat-card-content class="csv-modal-body">
      <div class="csv-table-container">
        <div class="table-scroll-wrapper-csv">
          <table mat-table [dataSource]="csvData" class="csv-preview-table">
            <!-- ReelID Column -->
            <ng-container matColumnDef="reelId">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>ReelID</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.reelId }}</td>
            </ng-container>

            <!-- SAPCode Column -->
            <ng-container matColumnDef="sapCode">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>SAPCode</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.sapCode }}</td>
            </ng-container>

            <!-- PartNumber Column -->
            <ng-container matColumnDef="partNumber">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>PartNumber</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.partNumber }}</td>
            </ng-container>

            <!-- LOT Column -->
            <ng-container matColumnDef="lot">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>LOT</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.lot }}</td>
            </ng-container>

            <!-- StorageUnit Column -->
            <ng-container matColumnDef="storageUnit">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>StorageUnit</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.storageUnit }}</td>
            </ng-container>

            <!-- InitialQuantity Column -->
            <ng-container matColumnDef="initialQuantity">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>InitialQuantity</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">
                {{ item.initialQuantity }}
              </td>
            </ng-container>

            <!-- Vendor Column -->
            <ng-container matColumnDef="vendor">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>Vendor</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.vendor }}</td>
            </ng-container>

            <!-- UserData1 Column -->
            <ng-container matColumnDef="userData1">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>UserData1</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.userData1 }}</td>
            </ng-container>

            <!-- UserData2 Column -->
            <ng-container matColumnDef="userData2">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>UserData2</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.userData2 }}</td>
            </ng-container>

            <!-- UserData3 Column -->
            <ng-container matColumnDef="userData3">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>UserData3</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.userData3 }}</td>
            </ng-container>

            <!-- UserData4 Column -->
            <ng-container matColumnDef="userData4">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>UserData4</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.userData4 }}</td>
            </ng-container>

            <!-- UserData5 Column -->
            <ng-container matColumnDef="userData5">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>UserData5</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.userData5 }}</td>
            </ng-container>

            <!-- ExpirationDate Column -->
            <ng-container matColumnDef="expirationDate">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>ExpirationDate</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.expirationDate }}</td>
            </ng-container>

            <!-- ManufacturingDate Column -->
            <ng-container matColumnDef="manufacturingDate">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>ManufacturingDate</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">
                {{ item.manufacturingDate }}
              </td>
            </ng-container>

            <!-- ArrivalDate Column -->
            <ng-container matColumnDef="arrivalDate">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>ArrivalDate</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.arrivalDate }}</td>
            </ng-container>

            <!-- slTemQuantity Column -->
            <!-- <ng-container matColumnDef="slTemQuantity">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-with-filter">
                  <span>slTemQuantity</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let item">{{ item.slTemQuantity }}</td>
            </ng-container> -->

            <!-- Header & Rows -->
            <tr mat-header-row *matHeaderRowDef="csvColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: csvColumns"></tr>
          </table>
        </div>
      </div>
    </mat-card-content>

    <mat-divider></mat-divider>

    <!-- Footer -->
    <mat-card-actions class="csv-modal-footer">
      <button mat-raised-button (click)="closeCsvModal()">
        <mat-icon>close</mat-icon>
        Hủy
      </button>
      <button mat-raised-button color="primary" (click)="exportCsv()">
        <mat-icon>file_download</mat-icon>
        Xuất CSV
      </button>
    </mat-card-actions>
  </mat-card>
</div>
<!-- Print Preview Modal -->
<div
  class="modal fade"
  id="printPreviewModal"
  tabindex="-1"
  [class.show]="showPrintModal"
  [style.display]="showPrintModal ? 'block' : 'none'"
>
  <div class="modal-dialog modal-fullscreen modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-2">
        <div style="display: flex; gap: 20px">
          <button
            mat-raised-button
            color="primary"
            (click)="printTable()"
            matTooltip="In tem"
          >
            <fa-icon [icon]="faPrint"></fa-icon> In
          </button>
          <h5>Preview In Tem ({{ filteredLabels.length }} tem)</h5>
        </div>

        <button
          type="button"
          class="btn-close"
          (click)="closePrintModal()"
        ></button>
      </div>
      <div class="modal-body pt-0" style="background-color: #f5f5f5">
        <div class="print-preview-container">
          <div
            class="label"
            *ngFor="
              let label of filteredLabels;
              let i = index;
              trackBy: trackByLabelId
            "
          >
            <div class="label-content">
              <!-- Cột 1: QR Code + MSD Info -->
              <div class="col-left">
                <div class="qr-box">
                  <qrcode
                    [qrdata]="label.qrCode"
                    [width]="90"
                    [margin]="0"
                    [errorCorrectionLevel]="'M'"
                    [attr.data-label-id]="label.id + '-' + i"
                  >
                  </qrcode>
                </div>
                <div class="msd-info">
                  <div class="msd-title">MSD:</div>
                  <div class="msd-item">
                    Date: {{ label.manufacturingDate }}
                  </div>
                  <div class="msd-item">Exp: {{ label.expirationDate }}</div>
                </div>
              </div>

              <!-- Cột 2: Center Content -->
              <div class="col-center">
                <div class="logo-box">
                  <img
                    src="../../../content/images/logo-rang-dong.webp"
                    alt="Logo"
                    class="logo-img"
                  />
                </div>
                <div class="sap-code">{{ label.sapCode }}</div>
                <div class="part-number">{{ label.partNumber }}</div>
                <div class="reel-id-tem">{{ label.reelId }}</div>
                <div class="info-grid-tem">
                  <div class="info-row-tem">
                    <span class="info-label-tem">Qty:</span>
                    <span class="info-value-tem qty-big">{{
                      label.initialQuantity
                    }}</span>
                  </div>
                  <div class="info-row-tem">
                    <span class="info-label-tem">Vendor:</span>
                    <span class="info-value-tem">{{ label.vendor }}</span>
                  </div>
                  <div class="info-row-tem">
                    <span class="info-label-tem">LOT:</span>
                    <span class="info-value-tem">{{ label.lot }}</span>
                  </div>
                </div>
              </div>

              <!-- Cột 3: Rank + Barcode -->
              <div class="col-right">
                <div class="rank-section">
                  <div class="rank-item-small">
                    <span>Rank M:</span>
                    <span class="rank-val">{{ label.userData1 }}</span>
                  </div>
                  <div class="rank-item-small">
                    <span>Rank A:</span>
                    <span class="rank-val">{{ label.userData2 }}</span>
                  </div>
                  <div class="rank-item-small">
                    <span>Rank Q:</span>
                    <span class="rank-val">{{ label.userData3 }}</span>
                  </div>
                </div>

                <div class="storage-unit">{{ label.storageUnit }}</div>
                <div class="lot-info">
                  <span>Lo:</span>
                  <span class="lot-info-bold">{{ label.lot }}</span>
                </div>

                <div class="barcode-box">
                  <div class="bc-item-compact">
                    <div class="bc-line">
                      <div class="bc-label">NN:</div>
                      <div class="bc-code">
                        {{ formatArrivalDate(label.arrivalDate) }}
                      </div>
                    </div>
                    <div class="bc-svg">
                      <svg [id]="'barcode-nv-' + label.id + '-' + i"></svg>
                    </div>
                  </div>

                  <div class="bc-item-compact">
                    <div class="bc-line">
                      <div class="bc-label">Po:</div>
                      <div class="bc-code">{{ label.userData5 }}</div>
                    </div>
                    <div class="bc-svg">
                      <svg [id]="'barcode-po-' + label.id + '-' + i"></svg>
                    </div>
                  </div>
                </div>
                <div class="product-name-small">{{ label.productName }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
